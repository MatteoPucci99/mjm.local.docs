@page "/"
@attribute [Authorize]
@rendermode InteractiveServer
@using Mjm.LocalDocs.Core.Abstractions
@using Mjm.LocalDocs.Core.Models
@inject IProjectRepository ProjectRepository
@inject IDocumentRepository DocumentRepository
@inject NavigationManager Navigation

<PageTitle>Dashboard - Local Docs</PageTitle>

@if (_loading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="mx-auto d-block my-8" />
}
else
{
    <MudText Typo="Typo.h4" Class="mb-4">Dashboard</MudText>
    
    <MudGrid>
        @* Statistics Cards *@
        <MudItem xs="12" sm="6" md="4">
            <MudPaper Class="pa-4" Elevation="2">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Folder" Color="Color.Primary" Size="Size.Large" Class="mr-3" />
                    <div>
                        <MudText Typo="Typo.h4" Color="Color.Primary">@_projectCount</MudText>
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">Progetti</MudText>
                    </div>
                </div>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="4">
            <MudPaper Class="pa-4" Elevation="2">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Description" Color="Color.Secondary" Size="Size.Large" Class="mr-3" />
                    <div>
                        <MudText Typo="Typo.h4" Color="Color.Secondary">@_documentCount</MudText>
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">Documenti</MudText>
                    </div>
                </div>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="4">
            <MudPaper Class="pa-4" Elevation="2">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Storage" Color="Color.Info" Size="Size.Large" Class="mr-3" />
                    <div>
                        <MudText Typo="Typo.h4" Color="Color.Info">@FormatFileSize(_totalSize)</MudText>
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">Dimensione Totale</MudText>
                    </div>
                </div>
            </MudPaper>
        </MudItem>
        
        @* Quick Actions *@
        <MudItem xs="12">
            <MudText Typo="Typo.h6" Class="mb-3 mt-4">Azioni Rapide</MudText>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="4">
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       StartIcon="@Icons.Material.Filled.Add"
                       FullWidth="true"
                       Size="Size.Large"
                       OnClick="@(() => Navigation.NavigateTo("/projects/new"))">
                Nuovo Progetto
            </MudButton>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="4">
            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Primary" 
                       StartIcon="@Icons.Material.Filled.List"
                       FullWidth="true"
                       Size="Size.Large"
                       OnClick="@(() => Navigation.NavigateTo("/projects"))">
                Tutti i Progetti
            </MudButton>
        </MudItem>
        
        @* Recent Projects *@
        @if (_recentProjects.Count > 0)
        {
            <MudItem xs="12">
                <MudText Typo="Typo.h6" Class="mb-3 mt-4">Progetti Recenti</MudText>
            </MudItem>
            
            @foreach (var project in _recentProjects)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="2" Class="cursor-pointer" @onclick="@(() => Navigation.NavigateTo($"/projects/{project.Id}"))">
                        <MudCardContent>
                            <div class="d-flex align-center mb-2">
                                <MudIcon Icon="@Icons.Material.Filled.Folder" Color="Color.Primary" Class="mr-2" />
                                <MudText Typo="Typo.h6">@project.Name</MudText>
                            </div>
                            @if (!string.IsNullOrEmpty(project.Description))
                            {
                                <MudText Typo="Typo.body2" Class="mud-text-secondary" Style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    @project.Description
                                </MudText>
                            }
                            <MudText Typo="Typo.caption" Class="mud-text-secondary mt-2">
                                @GetDocumentCountForProject(project.Id) documenti
                            </MudText>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small">
                                Apri
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        }
        else if (_projectCount == 0)
        {
            <MudItem xs="12">
                <MudAlert Severity="Severity.Info" Class="mt-4">
                    Non hai ancora creato nessun progetto. Clicca su "Nuovo Progetto" per iniziare.
                </MudAlert>
            </MudItem>
        }
    </MudGrid>
}

@code {
    private bool _loading = true;
    private int _projectCount;
    private int _documentCount;
    private long _totalSize;
    private List<Project> _recentProjects = [];
    private Dictionary<string, int> _projectDocumentCounts = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _loading = true;
        
        var projects = await ProjectRepository.GetAllAsync();
        _projectCount = projects.Count;
        _recentProjects = projects
            .OrderByDescending(p => p.UpdatedAt ?? p.CreatedAt)
            .Take(6)
            .ToList();

        _documentCount = 0;
        _totalSize = 0;
        _projectDocumentCounts.Clear();

        foreach (var project in projects)
        {
            var docs = await DocumentRepository.GetDocumentsByProjectAsync(project.Id);
            _projectDocumentCounts[project.Id] = docs.Count;
            _documentCount += docs.Count;
            _totalSize += docs.Sum(d => d.FileSizeBytes);
        }

        _loading = false;
    }

    private int GetDocumentCountForProject(string projectId)
    {
        return _projectDocumentCounts.TryGetValue(projectId, out var count) ? count : 0;
    }

    private static string FormatFileSize(long bytes)
    {
        string[] sizes = ["B", "KB", "MB", "GB"];
        int order = 0;
        double size = bytes;
        
        while (size >= 1024 && order < sizes.Length - 1)
        {
            order++;
            size /= 1024;
        }
        
        return $"{size:0.##} {sizes[order]}";
    }
}
