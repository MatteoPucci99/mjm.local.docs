@page "/settings/tokens"
@attribute [Authorize]
@rendermode InteractiveServer
@using Microsoft.Extensions.Options
@using Mjm.LocalDocs.Core.Models
@using Mjm.LocalDocs.Core.Services
@inject ApiTokenService TokenService
@inject IOptions<McpOptions> McpOptions
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>API Tokens - Local Docs</PageTitle>

<div class="d-flex justify-space-between align-center mb-4">
    <div>
        <MudText Typo="Typo.h4">API Tokens</MudText>
        <MudText Typo="Typo.body2" Class="mud-text-secondary">
            Manage authentication tokens for the MCP server
        </MudText>
    </div>
    <MudButton Variant="Variant.Filled"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.Add"
               OnClick="OpenCreateDialogAsync">
        New Token
    </MudButton>
</div>

@if (!McpOptions.Value.RequireAuthentication)
{
    <MudAlert Severity="Severity.Warning" Class="mb-4">
        <MudText Typo="Typo.body2">
            <strong>Warning:</strong> MCP authentication is disabled.
            Tokens will not be required to access the MCP endpoint.
            To enable authentication, set <code>LocalDocs:Mcp:RequireAuthentication</code> to <code>true</code> in appsettings.json.
        </MudText>
    </MudAlert>
}

@if (_loading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="mx-auto d-block my-8" />
}
else if (_tokens.Count == 0)
{
    <MudAlert Severity="Severity.Info">
        No tokens configured. Click "New Token" to create one.
    </MudAlert>
}
else
{
    <MudDataGrid T="ApiToken"
                 Items="@_tokens"
                 SortMode="SortMode.Single"
                 Filterable="false"
                 Hideable="false"
                 Dense="false"
                 Striped="true"
                 Hover="true">
        <Columns>
            <PropertyColumn Property="x => x.Name" Title="Name" Sortable="true" />
            <TemplateColumn Title="Prefix" Sortable="false">
                <CellTemplate>
                    <MudText Typo="Typo.body2">
                        <code>@(context.Item.TokenPrefix ?? "-")...</code>
                    </MudText>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Status" Sortable="true">
                <CellTemplate>
                    @if (context.Item.IsRevoked)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Error">Revoked</MudChip>
                    }
                    else if (context.Item.ExpiresAt.HasValue && context.Item.ExpiresAt.Value < DateTimeOffset.UtcNow)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning">Expired</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Success">Active</MudChip>
                    }
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Created" Sortable="true">
                <CellTemplate>
                    <MudText Typo="Typo.body2">@context.Item.CreatedAt.LocalDateTime.ToString("dd/MM/yyyy HH:mm")</MudText>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Expiry" Sortable="true">
                <CellTemplate>
                    <MudText Typo="Typo.body2">
                        @(context.Item.ExpiresAt?.LocalDateTime.ToString("dd/MM/yyyy HH:mm") ?? "Never")
                    </MudText>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Last Used" Sortable="true">
                <CellTemplate>
                    <MudText Typo="Typo.body2">
                        @(context.Item.LastUsedAt?.LocalDateTime.ToString("dd/MM/yyyy HH:mm") ?? "Never")
                    </MudText>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Actions" Sortable="false">
                <CellTemplate>
                    @if (!context.Item.IsRevoked && context.Item.IsValid)
                    {
                        <MudTooltip Text="Revoke">
                            <MudIconButton Icon="@Icons.Material.Filled.Block"
                                           Size="Size.Small"
                                           Color="Color.Warning"
                                           OnClick="@(() => RevokeTokenAsync(context.Item))" />
                        </MudTooltip>
                    }
                    <MudTooltip Text="Delete">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Size="Size.Small"
                                       Color="Color.Error"
                                       OnClick="@(() => DeleteTokenAsync(context.Item))" />
                    </MudTooltip>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
}

@* Dialog per mostrare il token creato *@
<MudDialog @bind-Visible="_showTokenDialog" Options="@(new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">Token Created</MudText>
    </TitleContent>
    <DialogContent>
        <MudAlert Severity="Severity.Warning" Class="mb-4">
            <MudText Typo="Typo.body2">
                <strong>Important:</strong> Copy this token now. It will no longer be visible after closing this dialog.
            </MudText>
        </MudAlert>
        <MudTextField @bind-Value="_newlyCreatedToken"
                      Label="Token"
                      Variant="Variant.Outlined"
                      ReadOnly="true"
                      Adornment="Adornment.End"
                      AdornmentIcon="@Icons.Material.Filled.ContentCopy"
                      OnAdornmentClick="CopyTokenToClipboard"
                      FullWidth="true"
                      Class="mb-4" />
        <MudText Typo="Typo.body2" Class="mud-text-secondary">
            Use this token in the <code>Authorization: Bearer &lt;token&gt;</code> header to authenticate MCP requests.
        </MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseTokenDialog" Variant="Variant.Filled" Color="Color.Primary">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private bool _loading = true;
    private List<ApiToken> _tokens = [];
    private bool _showTokenDialog;
    private string _newlyCreatedToken = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadTokensAsync();
    }

    private async Task LoadTokensAsync()
    {
        _loading = true;
        StateHasChanged();

        var tokens = await TokenService.GetAllTokensAsync();
        _tokens = tokens.ToList();

        _loading = false;
    }

    private async Task OpenCreateDialogAsync()
    {
        var parameters = new DialogParameters<CreateTokenDialog>();
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CreateTokenDialog>("New Token", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: CreateTokenResult tokenResult })
        {
            try
            {
                var (token, plainTextToken) = await TokenService.CreateTokenAsync(
                    tokenResult.Name,
                    tokenResult.ExpiresAt);

                _newlyCreatedToken = plainTextToken;
                _showTokenDialog = true;

                await LoadTokensAsync();
                Snackbar.Add($"Token \"{token.Name}\" created successfully.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error creating token: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task RevokeTokenAsync(ApiToken token)
    {
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.ContentText, $"Are you sure you want to revoke token \"{token.Name}\"? The token will no longer be usable for authentication." },
            { x => x.ButtonText, "Revoke" },
            { x => x.Color, Color.Warning }
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Confirm Revocation", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            var revoked = await TokenService.RevokeTokenAsync(token.Id);
            if (revoked)
            {
                Snackbar.Add($"Token \"{token.Name}\" revoked successfully.", Severity.Success);
                await LoadTokensAsync();
            }
            else
            {
                Snackbar.Add("Error revoking token.", Severity.Error);
            }
        }
    }

    private async Task DeleteTokenAsync(ApiToken token)
    {
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.ContentText, $"Are you sure you want to permanently delete token \"{token.Name}\"?" },
            { x => x.ButtonText, "Delete" },
            { x => x.Color, Color.Error }
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Confirm Deletion", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            var deleted = await TokenService.DeleteTokenAsync(token.Id);
            if (deleted)
            {
                Snackbar.Add($"Token \"{token.Name}\" deleted successfully.", Severity.Success);
                await LoadTokensAsync();
            }
            else
            {
                Snackbar.Add("Error deleting token.", Severity.Error);
            }
        }
    }

    private async Task CopyTokenToClipboard()
    {
        // Note: Clipboard API requires JavaScript interop
        // For now, show a message that the token can be manually copied
        Snackbar.Add("Select and copy the token manually (Ctrl+C)", Severity.Info);
    }

    private void CloseTokenDialog()
    {
        _showTokenDialog = false;
        _newlyCreatedToken = string.Empty;
    }

    public sealed record CreateTokenResult(string Name, DateTimeOffset? ExpiresAt);
}
