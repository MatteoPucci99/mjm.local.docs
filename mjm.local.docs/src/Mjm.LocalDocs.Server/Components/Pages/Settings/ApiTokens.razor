@page "/settings/tokens"
@attribute [Authorize]
@rendermode InteractiveServer
@using Microsoft.Extensions.Options
@using Mjm.LocalDocs.Core.Models
@using Mjm.LocalDocs.Core.Services
@inject ApiTokenService TokenService
@inject IOptions<McpOptions> McpOptions
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>API Tokens - Local Docs</PageTitle>

<div class="d-flex justify-space-between align-center mb-4">
    <div>
        <MudText Typo="Typo.h4">API Tokens</MudText>
        <MudText Typo="Typo.body2" Class="mud-text-secondary">
            Gestisci i token di autenticazione per il server MCP
        </MudText>
    </div>
    <MudButton Variant="Variant.Filled"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.Add"
               OnClick="OpenCreateDialogAsync">
        Nuovo Token
    </MudButton>
</div>

@if (!McpOptions.Value.RequireAuthentication)
{
    <MudAlert Severity="Severity.Warning" Class="mb-4">
        <MudText Typo="Typo.body2">
            <strong>Attenzione:</strong> L'autenticazione MCP e disabilitata.
            I token non saranno richiesti per accedere all'endpoint MCP.
            Per abilitare l'autenticazione, imposta <code>LocalDocs:Mcp:RequireAuthentication</code> a <code>true</code> in appsettings.json.
        </MudText>
    </MudAlert>
}

@if (_loading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="mx-auto d-block my-8" />
}
else if (_tokens.Count == 0)
{
    <MudAlert Severity="Severity.Info">
        Non ci sono token configurati. Clicca su "Nuovo Token" per crearne uno.
    </MudAlert>
}
else
{
    <MudDataGrid T="ApiToken"
                 Items="@_tokens"
                 SortMode="SortMode.Single"
                 Filterable="false"
                 Hideable="false"
                 Dense="false"
                 Striped="true"
                 Hover="true">
        <Columns>
            <PropertyColumn Property="x => x.Name" Title="Nome" Sortable="true" />
            <TemplateColumn Title="Prefisso" Sortable="false">
                <CellTemplate>
                    <MudText Typo="Typo.body2">
                        <code>@(context.Item.TokenPrefix ?? "-")...</code>
                    </MudText>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Stato" Sortable="true">
                <CellTemplate>
                    @if (context.Item.IsRevoked)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Error">Revocato</MudChip>
                    }
                    else if (context.Item.ExpiresAt.HasValue && context.Item.ExpiresAt.Value < DateTimeOffset.UtcNow)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning">Scaduto</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Success">Attivo</MudChip>
                    }
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Creato" Sortable="true">
                <CellTemplate>
                    <MudText Typo="Typo.body2">@context.Item.CreatedAt.LocalDateTime.ToString("dd/MM/yyyy HH:mm")</MudText>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Scadenza" Sortable="true">
                <CellTemplate>
                    <MudText Typo="Typo.body2">
                        @(context.Item.ExpiresAt?.LocalDateTime.ToString("dd/MM/yyyy HH:mm") ?? "Mai")
                    </MudText>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Ultimo Uso" Sortable="true">
                <CellTemplate>
                    <MudText Typo="Typo.body2">
                        @(context.Item.LastUsedAt?.LocalDateTime.ToString("dd/MM/yyyy HH:mm") ?? "Mai")
                    </MudText>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Azioni" Sortable="false">
                <CellTemplate>
                    @if (!context.Item.IsRevoked && context.Item.IsValid)
                    {
                        <MudTooltip Text="Revoca">
                            <MudIconButton Icon="@Icons.Material.Filled.Block"
                                           Size="Size.Small"
                                           Color="Color.Warning"
                                           OnClick="@(() => RevokeTokenAsync(context.Item))" />
                        </MudTooltip>
                    }
                    <MudTooltip Text="Elimina">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Size="Size.Small"
                                       Color="Color.Error"
                                       OnClick="@(() => DeleteTokenAsync(context.Item))" />
                    </MudTooltip>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
}

@* Dialog per mostrare il token creato *@
<MudDialog @bind-Visible="_showTokenDialog" Options="@(new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">Token Creato</MudText>
    </TitleContent>
    <DialogContent>
        <MudAlert Severity="Severity.Warning" Class="mb-4">
            <MudText Typo="Typo.body2">
                <strong>Importante:</strong> Copia questo token ora. Non sara piu possibile visualizzarlo.
            </MudText>
        </MudAlert>
        <MudTextField @bind-Value="_newlyCreatedToken"
                      Label="Token"
                      Variant="Variant.Outlined"
                      ReadOnly="true"
                      Adornment="Adornment.End"
                      AdornmentIcon="@Icons.Material.Filled.ContentCopy"
                      OnAdornmentClick="CopyTokenToClipboard"
                      FullWidth="true"
                      Class="mb-4" />
        <MudText Typo="Typo.body2" Class="mud-text-secondary">
            Usa questo token nell'header <code>Authorization: Bearer &lt;token&gt;</code> per autenticare le richieste MCP.
        </MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseTokenDialog" Variant="Variant.Filled" Color="Color.Primary">Chiudi</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private bool _loading = true;
    private List<ApiToken> _tokens = [];
    private bool _showTokenDialog;
    private string _newlyCreatedToken = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadTokensAsync();
    }

    private async Task LoadTokensAsync()
    {
        _loading = true;
        StateHasChanged();

        var tokens = await TokenService.GetAllTokensAsync();
        _tokens = tokens.ToList();

        _loading = false;
    }

    private async Task OpenCreateDialogAsync()
    {
        var parameters = new DialogParameters<CreateTokenDialog>();
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CreateTokenDialog>("Nuovo Token", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: CreateTokenResult tokenResult })
        {
            try
            {
                var (token, plainTextToken) = await TokenService.CreateTokenAsync(
                    tokenResult.Name,
                    tokenResult.ExpiresAt);

                _newlyCreatedToken = plainTextToken;
                _showTokenDialog = true;

                await LoadTokensAsync();
                Snackbar.Add($"Token \"{token.Name}\" creato con successo.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Errore durante la creazione del token: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task RevokeTokenAsync(ApiToken token)
    {
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.ContentText, $"Sei sicuro di voler revocare il token \"{token.Name}\"? Il token non potra piu essere utilizzato per l'autenticazione." },
            { x => x.ButtonText, "Revoca" },
            { x => x.Color, Color.Warning }
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Conferma Revoca", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            var revoked = await TokenService.RevokeTokenAsync(token.Id);
            if (revoked)
            {
                Snackbar.Add($"Token \"{token.Name}\" revocato con successo.", Severity.Success);
                await LoadTokensAsync();
            }
            else
            {
                Snackbar.Add("Errore durante la revoca del token.", Severity.Error);
            }
        }
    }

    private async Task DeleteTokenAsync(ApiToken token)
    {
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.ContentText, $"Sei sicuro di voler eliminare permanentemente il token \"{token.Name}\"?" },
            { x => x.ButtonText, "Elimina" },
            { x => x.Color, Color.Error }
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Conferma Eliminazione", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            var deleted = await TokenService.DeleteTokenAsync(token.Id);
            if (deleted)
            {
                Snackbar.Add($"Token \"{token.Name}\" eliminato con successo.", Severity.Success);
                await LoadTokensAsync();
            }
            else
            {
                Snackbar.Add("Errore durante l'eliminazione del token.", Severity.Error);
            }
        }
    }

    private async Task CopyTokenToClipboard()
    {
        // Note: Clipboard API requires JavaScript interop
        // For now, show a message that the token can be manually copied
        Snackbar.Add("Seleziona e copia il token manualmente (Ctrl+C)", Severity.Info);
    }

    private void CloseTokenDialog()
    {
        _showTokenDialog = false;
        _newlyCreatedToken = string.Empty;
    }

    public sealed record CreateTokenResult(string Name, DateTimeOffset? ExpiresAt);
}
