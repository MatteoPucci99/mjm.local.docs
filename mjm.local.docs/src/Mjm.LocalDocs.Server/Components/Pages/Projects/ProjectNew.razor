@page "/projects/new"
@attribute [Authorize]
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations
@using Mjm.LocalDocs.Core.Abstractions
@using Mjm.LocalDocs.Core.Models
@inject IProjectRepository ProjectRepository
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>New Project - Local Docs</PageTitle>

<MudBreadcrumbs Items="_breadcrumbs" Class="mb-4 px-0" />

<MudText Typo="Typo.h4" Class="mb-4">New Project</MudText>

<MudPaper Class="pa-6" Elevation="2" MaxWidth="600px">
    <EditForm Model="@_model" OnValidSubmit="CreateProjectAsync">
        <DataAnnotationsValidator />
        
        <MudTextField @bind-Value="_model.Name"
                      Label="Project Name"
                      Required="true"
                      RequiredError="Project name is required"
                      Variant="Variant.Outlined"
                      Class="mb-4"
                      MaxLength="100"
                      HelperText="Unique name to identify the project"
                      Error="@(!string.IsNullOrEmpty(_nameError))"
                      ErrorText="@_nameError" />
        
        <MudTextField @bind-Value="_model.Description"
                      Label="Description"
                      Variant="Variant.Outlined"
                      Class="mb-4"
                      Lines="3"
                      MaxLength="500"
                      HelperText="Optional description for the project" />
        
        <div class="d-flex gap-3 mt-4">
            <MudButton ButtonType="ButtonType.Submit"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       Disabled="@_saving"
                       StartIcon="@Icons.Material.Filled.Save">
                @if (_saving)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Creating...</span>
                }
                else
                {
                    <span>Create Project</span>
                }
            </MudButton>
            
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       OnClick="@(() => Navigation.NavigateTo("/projects"))"
                       Disabled="@_saving">
                Cancel
            </MudButton>
        </div>
    </EditForm>
</MudPaper>

@code {
    private readonly ProjectFormModel _model = new();
    private bool _saving;
    private string? _nameError;
    
    private readonly List<BreadcrumbItem> _breadcrumbs =
    [
        new("Dashboard", href: "/", icon: Icons.Material.Filled.Home),
        new("Projects", href: "/projects", icon: Icons.Material.Filled.Folder),
        new("New", href: null, disabled: true)
    ];

    private async Task CreateProjectAsync()
    {
        _nameError = null;
        
        if (string.IsNullOrWhiteSpace(_model.Name))
        {
            _nameError = "Project name is required";
            return;
        }

        // Check if project name already exists
        if (await ProjectRepository.ExistsByNameAsync(_model.Name.Trim()))
        {
            _nameError = "A project with this name already exists";
            return;
        }

        _saving = true;
        StateHasChanged();

        try
        {
            var project = new Project
            {
                Id = Guid.NewGuid().ToString(),
                Name = _model.Name.Trim(),
                Description = string.IsNullOrWhiteSpace(_model.Description) ? null : _model.Description.Trim()
            };

            await ProjectRepository.CreateAsync(project);
            
            Snackbar.Add($"Project \"{project.Name}\" created successfully!", Severity.Success);
            Navigation.NavigateTo($"/projects/{project.Id}");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating project: {ex.Message}", Severity.Error);
            _saving = false;
        }
    }

    private sealed class ProjectFormModel
    {
        [Required(ErrorMessage = "Project name is required")]
        [MaxLength(100, ErrorMessage = "Name cannot exceed 100 characters")]
        public string Name { get; set; } = string.Empty;

        [MaxLength(500, ErrorMessage = "Description cannot exceed 500 characters")]
        public string? Description { get; set; }
    }
}
