@page "/projects/new"
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations
@using Mjm.LocalDocs.Core.Abstractions
@using Mjm.LocalDocs.Core.Models
@inject IProjectRepository ProjectRepository
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Nuovo Progetto - Local Docs</PageTitle>

<MudBreadcrumbs Items="_breadcrumbs" Class="mb-4 px-0" />

<MudText Typo="Typo.h4" Class="mb-4">Nuovo Progetto</MudText>

<MudPaper Class="pa-6" Elevation="2" MaxWidth="600px">
    <EditForm Model="@_model" OnValidSubmit="CreateProjectAsync">
        <DataAnnotationsValidator />
        
        <MudTextField @bind-Value="_model.Name"
                      Label="Nome Progetto"
                      Required="true"
                      RequiredError="Il nome del progetto e' obbligatorio"
                      Variant="Variant.Outlined"
                      Class="mb-4"
                      MaxLength="100"
                      HelperText="Nome univoco per identificare il progetto"
                      Error="@(!string.IsNullOrEmpty(_nameError))"
                      ErrorText="@_nameError" />
        
        <MudTextField @bind-Value="_model.Description"
                      Label="Descrizione"
                      Variant="Variant.Outlined"
                      Class="mb-4"
                      Lines="3"
                      MaxLength="500"
                      HelperText="Descrizione opzionale del progetto" />
        
        <div class="d-flex gap-3 mt-4">
            <MudButton ButtonType="ButtonType.Submit"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       Disabled="@_saving"
                       StartIcon="@Icons.Material.Filled.Save">
                @if (_saving)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Creazione...</span>
                }
                else
                {
                    <span>Crea Progetto</span>
                }
            </MudButton>
            
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       OnClick="@(() => Navigation.NavigateTo("/projects"))"
                       Disabled="@_saving">
                Annulla
            </MudButton>
        </div>
    </EditForm>
</MudPaper>

@code {
    private readonly ProjectFormModel _model = new();
    private bool _saving;
    private string? _nameError;
    
    private readonly List<BreadcrumbItem> _breadcrumbs =
    [
        new("Dashboard", href: "/", icon: Icons.Material.Filled.Home),
        new("Progetti", href: "/projects", icon: Icons.Material.Filled.Folder),
        new("Nuovo", href: null, disabled: true)
    ];

    private async Task CreateProjectAsync()
    {
        _nameError = null;
        
        if (string.IsNullOrWhiteSpace(_model.Name))
        {
            _nameError = "Il nome del progetto e' obbligatorio";
            return;
        }

        // Check if project name already exists
        if (await ProjectRepository.ExistsByNameAsync(_model.Name.Trim()))
        {
            _nameError = "Esiste gia' un progetto con questo nome";
            return;
        }

        _saving = true;
        StateHasChanged();

        try
        {
            var project = new Project
            {
                Id = Guid.NewGuid().ToString(),
                Name = _model.Name.Trim(),
                Description = string.IsNullOrWhiteSpace(_model.Description) ? null : _model.Description.Trim()
            };

            await ProjectRepository.CreateAsync(project);
            
            Snackbar.Add($"Progetto \"{project.Name}\" creato con successo!", Severity.Success);
            Navigation.NavigateTo($"/projects/{project.Id}");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Errore durante la creazione: {ex.Message}", Severity.Error);
            _saving = false;
        }
    }

    private sealed class ProjectFormModel
    {
        [Required(ErrorMessage = "Il nome del progetto e' obbligatorio")]
        [MaxLength(100, ErrorMessage = "Il nome non puo' superare i 100 caratteri")]
        public string Name { get; set; } = string.Empty;

        [MaxLength(500, ErrorMessage = "La descrizione non puo' superare i 500 caratteri")]
        public string? Description { get; set; }
    }
}
