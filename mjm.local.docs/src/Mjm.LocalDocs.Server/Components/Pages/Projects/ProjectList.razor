@page "/projects"
@attribute [Authorize]
@rendermode InteractiveServer
 @using Mjm.LocalDocs.Core.Abstractions
 @using Mjm.LocalDocs.Core.Models
 @inject IProjectRepository ProjectRepository
 @inject IDocumentRepository DocumentRepository
 @inject NavigationManager Navigation
 @inject IDialogService DialogService
 @inject ISnackbar Snackbar

 <PageTitle>Progetti - Local Docs</PageTitle>

 <div class="d-flex justify-space-between align-center mb-4">
     <MudText Typo="Typo.h4">Progetti</MudText>
     <MudButton Variant="Variant.Filled" 
                Color="Color.Primary" 
                StartIcon="@Icons.Material.Filled.Add"
                OnClick="@(() => Navigation.NavigateTo("/projects/new"))">
         Nuovo Progetto
     </MudButton>
 </div>

 @if (_loading)
 {
     <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="mx-auto d-block my-8" />
 }
 else if (_projects.Count == 0)
 {
     <MudAlert Severity="Severity.Info">
         Non ci sono progetti. Clicca su "Nuovo Progetto" per crearne uno.
     </MudAlert>
 }
 else
 {
     <MudTextField @bind-Value="_searchText"
                   Placeholder="Cerca progetti..."
                   Adornment="Adornment.Start"
                   AdornmentIcon="@Icons.Material.Filled.Search"
                   Immediate="true"
                   DebounceInterval="300"
                   Variant="Variant.Outlined"
                   Class="mb-4"
                   Clearable="true"
                   OnClearButtonClick="@(() => { _searchText = string.Empty; })" />

     <MudDataGrid T="ProjectListItem"
                  Items="@FilteredProjects"
                  SortMode="SortMode.Single"
                  Filterable="false"
                  Hideable="false"
                  Dense="false"
                  Striped="true"
                  Hover="true">
         <Columns>
             <TemplateColumn Title="Nome" Sortable="true">
                 <CellTemplate>
                     <MudLink Href="@($"/projects/{context.Item.Project.Id}")" Typo="Typo.body1" Color="Color.Primary">
                         @context.Item.Project.Name
                     </MudLink>
                 </CellTemplate>
             </TemplateColumn>
             <TemplateColumn Title="Descrizione" Sortable="true">
                 <CellTemplate>
                     <MudText Typo="Typo.body2" Style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                         @(context.Item.Project.Description ?? "-")
                     </MudText>
                 </CellTemplate>
             </TemplateColumn>
             <TemplateColumn Title="Documenti" Sortable="true">
                 <CellTemplate>
                     <MudChip T="string" Size="Size.Small" Color="Color.Default">@context.Item.DocumentCount</MudChip>
                 </CellTemplate>
             </TemplateColumn>
             <TemplateColumn Title="Creato" Sortable="true">
                 <CellTemplate>
                     <MudText Typo="Typo.body2">@context.Item.Project.CreatedAt.LocalDateTime.ToString("dd/MM/yyyy HH:mm")</MudText>
                 </CellTemplate>
             </TemplateColumn>
             <TemplateColumn Title="Azioni" Sortable="false">
                 <CellTemplate>
                     <MudTooltip Text="Modifica">
                         <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                        Size="Size.Small" 
                                        Color="Color.Primary"
                                        OnClick="@(() => Navigation.NavigateTo($"/projects/{context.Item.Project.Id}"))" />
                     </MudTooltip>
                     <MudTooltip Text="Elimina">
                         <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                        Size="Size.Small" 
                                        Color="Color.Error"
                                        OnClick="@(() => DeleteProjectAsync(context.Item.Project))" />
                     </MudTooltip>
                 </CellTemplate>
             </TemplateColumn>
         </Columns>
     </MudDataGrid>
 }

 @code {
     private bool _loading = true;
     private List<ProjectListItem> _projects = [];
     private string _searchText = string.Empty;

     private IEnumerable<ProjectListItem> FilteredProjects => string.IsNullOrWhiteSpace(_searchText)
         ? _projects
         : _projects
             .Where(p => p.Project.Name.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                         (p.Project.Description?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false));

     protected override async Task OnInitializedAsync()
     {
         await LoadProjectsAsync();
     }

     private async Task LoadProjectsAsync()
     {
         _loading = true;
         StateHasChanged();
         
         var projects = await ProjectRepository.GetAllAsync();
         _projects.Clear();

         foreach (var project in projects)
         {
             var docs = await DocumentRepository.GetDocumentsByProjectAsync(project.Id);
             _projects.Add(new ProjectListItem(project, docs.Count));
         }

         _loading = false;
     }

     private async Task DeleteProjectAsync(Project project)
     {
         var parameters = new DialogParameters<ConfirmDialog>
         {
             { x => x.ContentText, $"Sei sicuro di voler eliminare il progetto \"{project.Name}\"? Verranno eliminati anche tutti i documenti e i dati associati." },
             { x => x.ButtonText, "Elimina" },
             { x => x.Color, Color.Error }
         };

         var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small };
         var dialog = await DialogService.ShowAsync<ConfirmDialog>("Conferma Eliminazione", parameters, options);
         var result = await dialog.Result;

         if (result is { Canceled: false })
         {
             var deleted = await ProjectRepository.DeleteAsync(project.Id);
             if (deleted)
             {
                 Snackbar.Add($"Progetto \"{project.Name}\" eliminato con successo.", Severity.Success);
                 await LoadProjectsAsync();
             }
             else
             {
                 Snackbar.Add("Errore durante l'eliminazione del progetto.", Severity.Error);
             }
         }
     }

     private sealed record ProjectListItem(Project Project, int DocumentCount);
 }
