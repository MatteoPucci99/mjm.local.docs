@using MudBlazor
@using Mjm.LocalDocs.Core.Models
@using Microsoft.AspNetCore.Components.Forms

<MudDialog>
    <DialogContent>
        <MudAlert Severity="Severity.Info" Class="mb-4" Dense="true">
            La versione corrente (v@(Document.VersionNumber)) verra' conservata come storico.
            I risultati di ricerca punteranno alla nuova versione.
        </MudAlert>

        <MudText Typo="Typo.body2" Class="mb-2">
            <strong>Documento:</strong> @Document.FileName
        </MudText>
        <MudText Typo="Typo.body2" Class="mb-4">
            <strong>Versione corrente:</strong> v@(Document.VersionNumber)
        </MudText>

        <MudPaper Outlined="true"
                  Class="@GetDropzoneClass()"
                  Style="border-width: 2px; min-height: 100px; position: relative;">
            <InputFile OnChange="OnFileSelected"
                       accept=".txt,.md,.pdf,.docx,.html,.htm,.json,.xml,.csv"
                       class="absolute mud-width-full mud-height-full overflow-hidden z-10"
                       style="opacity: 0; cursor: pointer;" />
            @if (_selectedFile is not null)
            {
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Large" />
                <MudText Typo="Typo.body2" Class="mt-2">
                    <strong>@_selectedFile.Name</strong> (@FormatFileSize(_selectedFile.Size))
                </MudText>
                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                    Clicca per cambiare file
                </MudText>
            }
            else
            {
                <MudIcon Icon="@Icons.Material.Filled.UploadFile" Color="Color.Primary" Size="Size.Large" />
                <MudText Typo="Typo.body2" Class="mt-2">
                    Seleziona il file della nuova versione
                </MudText>
                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                    Formati supportati: .txt, .md, .pdf, .docx, .html, .json, .xml, .csv
                </MudText>
            }
        </MudPaper>

        @if (!string.IsNullOrEmpty(_error))
        {
            <MudAlert Severity="Severity.Error" Class="mt-3" Dense="true">@_error</MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text" Disabled="_uploading">Annulla</MudButton>
        <MudButton OnClick="Submit"
                   Variant="Variant.Filled"
                   Color="Color.Primary"
                   Disabled="@(_selectedFile is null || _uploading)">
            @if (_uploading)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Aggiorna
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

    /// <summary>
    /// The document being updated (current version).
    /// </summary>
    [Parameter]
    public Document Document { get; set; } = null!;

    private IBrowserFile? _selectedFile;
    private bool _uploading;
    private string? _error;

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        _error = null;
        var file = e.File;

        if (file.Size > 50 * 1024 * 1024)
        {
            _error = "Il file supera il limite di 50 MB.";
            _selectedFile = null;
            return;
        }

        _selectedFile = file;
    }

    private async Task Submit()
    {
        if (_selectedFile is null) return;

        _uploading = true;
        _error = null;
        StateHasChanged();

        try
        {
            const long maxFileSize = 50 * 1024 * 1024;
            await using var stream = _selectedFile.OpenReadStream(maxFileSize);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            var fileContent = memoryStream.ToArray();

            MudDialog?.Close(DialogResult.Ok(new UpdateDocumentResult(
                _selectedFile.Name,
                fileContent)));
        }
        catch (Exception ex)
        {
            _error = $"Errore durante la lettura del file: {ex.Message}";
            _uploading = false;
            StateHasChanged();
        }
    }

    private void Cancel() => MudDialog?.Cancel();

    private string GetDropzoneClass() =>
        "pa-6 d-flex flex-column align-center justify-center cursor-pointer border-dashed";

    private static string FormatFileSize(long bytes)
    {
        string[] sizes = ["B", "KB", "MB", "GB"];
        int order = 0;
        double size = bytes;

        while (size >= 1024 && order < sizes.Length - 1)
        {
            order++;
            size /= 1024;
        }

        return $"{size:0.##} {sizes[order]}";
    }

    /// <summary>
    /// Result returned when the user confirms the update.
    /// </summary>
    public sealed record UpdateDocumentResult(string FileName, byte[] FileContent);
}
