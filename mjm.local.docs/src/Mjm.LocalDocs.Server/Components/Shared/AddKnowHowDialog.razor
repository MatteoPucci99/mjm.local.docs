@using MudBlazor
@using System.ComponentModel.DataAnnotations

<MudDialog>
    <DialogContent>
        <MudAlert Severity="Severity.Info" Class="mb-4" Dense="true">
            Create a know how document. The content will be indexed for semantic search.
        </MudAlert>

        <EditForm Model="@_model" OnValidSubmit="Submit">
            <DataAnnotationsValidator />

            <MudTextField @bind-Value="_model.Title"
                          Label="Title"
                          Required="true"
                          Variant="Variant.Outlined"
                          Class="mb-4"
                          MaxLength="200"
                          Placeholder="e.g. Production deployment guide"
                          For="@(() => _model.Title)"
                          Immediate="true" />

            <MudTextField @bind-Value="_model.Content"
                          Label="Content"
                          Required="true"
                          Variant="Variant.Outlined"
                          Lines="15"
                          MaxLength="500000"
                          Placeholder="Write the know how content... You can use Markdown formatting."
                          For="@(() => _model.Content)"
                          Class="mb-2"
                          Immediate="true" />

            <MudText Typo="Typo.caption" Class="mud-text-secondary">
                Supports Markdown formatting. The document will be saved as a .md file.
            </MudText>
        </EditForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text" Disabled="_saving">Cancel</MudButton>
        <MudButton OnClick="Submit"
                   Variant="Variant.Filled"
                   Color="Color.Primary"
                   Disabled="@(!IsValid || _saving)">
            @if (_saving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Save
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

    private readonly KnowHowModel _model = new();
    private bool _saving;

    private bool IsValid =>
        !string.IsNullOrWhiteSpace(_model.Title) &&
        !string.IsNullOrWhiteSpace(_model.Content);

    private void Submit()
    {
        if (!IsValid) return;

        _saving = true;
        StateHasChanged();

        MudDialog?.Close(DialogResult.Ok(new AddKnowHowResult(
            _model.Title!.Trim(),
            _model.Content!.Trim())));
    }

    private void Cancel() => MudDialog?.Cancel();

    /// <summary>
    /// Result returned when the user confirms the know how creation.
    /// </summary>
    public sealed record AddKnowHowResult(string Title, string Content);

    private sealed class KnowHowModel
    {
        [Required(ErrorMessage = "Title is required")]
        [MaxLength(200, ErrorMessage = "Title cannot exceed 200 characters")]
        public string? Title { get; set; }

        [Required(ErrorMessage = "Content is required")]
        [MaxLength(500000, ErrorMessage = "Content is too long")]
        public string? Content { get; set; }
    }
}
