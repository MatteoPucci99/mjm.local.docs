@using MudBlazor
@using System.ComponentModel.DataAnnotations

<MudDialog>
    <DialogContent>
        <MudAlert Severity="Severity.Info" Class="mb-4" Dense="true">
            Crea un documento di know how. Il contenuto verra' indicizzato per la ricerca semantica.
        </MudAlert>

        <EditForm Model="@_model" OnValidSubmit="Submit">
            <DataAnnotationsValidator />

            <MudTextField @bind-Value="_model.Title"
                          Label="Titolo"
                          Required="true"
                          Variant="Variant.Outlined"
                          Class="mb-4"
                          MaxLength="200"
                          Placeholder="Es. Guida al deploy in produzione"
                          For="@(() => _model.Title)"
                          Immediate="true" />

            <MudTextField @bind-Value="_model.Content"
                          Label="Contenuto"
                          Required="true"
                          Variant="Variant.Outlined"
                          Lines="15"
                          MaxLength="500000"
                          Placeholder="Scrivi il contenuto del know how... Puoi usare la formattazione Markdown."
                          For="@(() => _model.Content)"
                          Class="mb-2"
                          Immediate="true" />

            <MudText Typo="Typo.caption" Class="mud-text-secondary">
                Supporta formattazione Markdown. Il documento verra' salvato come file .md
            </MudText>
        </EditForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text" Disabled="_saving">Annulla</MudButton>
        <MudButton OnClick="Submit"
                   Variant="Variant.Filled"
                   Color="Color.Primary"
                   Disabled="@(!IsValid || _saving)">
            @if (_saving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Salva
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

    private readonly KnowHowModel _model = new();
    private bool _saving;

    private bool IsValid =>
        !string.IsNullOrWhiteSpace(_model.Title) &&
        !string.IsNullOrWhiteSpace(_model.Content);

    private void Submit()
    {
        if (!IsValid) return;

        _saving = true;
        StateHasChanged();

        MudDialog?.Close(DialogResult.Ok(new AddKnowHowResult(
            _model.Title!.Trim(),
            _model.Content!.Trim())));
    }

    private void Cancel() => MudDialog?.Cancel();

    /// <summary>
    /// Result returned when the user confirms the know how creation.
    /// </summary>
    public sealed record AddKnowHowResult(string Title, string Content);

    private sealed class KnowHowModel
    {
        [Required(ErrorMessage = "Il titolo e' obbligatorio")]
        [MaxLength(200, ErrorMessage = "Il titolo non puo' superare i 200 caratteri")]
        public string? Title { get; set; }

        [Required(ErrorMessage = "Il contenuto e' obbligatorio")]
        [MaxLength(500000, ErrorMessage = "Il contenuto e' troppo lungo")]
        public string? Content { get; set; }
    }
}
