@using MudBlazor
@using Mjm.LocalDocs.Core.Models
@using System.ComponentModel.DataAnnotations

<MudDialog>
    <DialogContent>
        <MudAlert Severity="Severity.Info" Class="mb-4" Dense="true">
            The current version (v@(Document.VersionNumber)) will be preserved as history.
            Search results will point to the new version.
        </MudAlert>

        <MudText Typo="Typo.body2" Class="mb-4">
            <strong>Document:</strong> @Document.FileName â€” <strong>Current version:</strong> v@(Document.VersionNumber)
        </MudText>

        <EditForm Model="@_model" OnValidSubmit="Submit">
            <DataAnnotationsValidator />

            <MudTextField @bind-Value="_model.Title"
                          Label="Title"
                          Required="true"
                          Variant="Variant.Outlined"
                          Class="mb-4"
                          MaxLength="200"
                          For="@(() => _model.Title)"
                          Immediate="true" />

            <MudTextField @bind-Value="_model.Content"
                          Label="Content"
                          Required="true"
                          Variant="Variant.Outlined"
                          Lines="15"
                          MaxLength="500000"
                          For="@(() => _model.Content)"
                          Class="mb-2"
                          Immediate="true" />

            <MudText Typo="Typo.caption" Class="mud-text-secondary">
                Supports Markdown formatting. Editing will create a new version (v@(Document.VersionNumber + 1)).
            </MudText>
        </EditForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text" Disabled="_saving">Cancel</MudButton>
        <MudButton OnClick="Submit"
                   Variant="Variant.Filled"
                   Color="Color.Primary"
                   Disabled="@(!IsValid || _saving)">
            @if (_saving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Update
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

    /// <summary>
    /// The document being edited (current version).
    /// </summary>
    [Parameter]
    public Document Document { get; set; } = null!;

    private readonly KnowHowModel _model = new();
    private bool _saving;

    private bool IsValid =>
        !string.IsNullOrWhiteSpace(_model.Title) &&
        !string.IsNullOrWhiteSpace(_model.Content);

    protected override void OnParametersSet()
    {
        if (Document is not null)
        {
            // Pre-fill with existing data
            _model.Title = Path.GetFileNameWithoutExtension(Document.FileName);
            _model.Content = Document.ExtractedText;
        }
    }

    private void Submit()
    {
        if (!IsValid) return;

        _saving = true;
        StateHasChanged();

        MudDialog?.Close(DialogResult.Ok(new EditKnowHowResult(
            _model.Title!.Trim(),
            _model.Content!.Trim())));
    }

    private void Cancel() => MudDialog?.Cancel();

    /// <summary>
    /// Result returned when the user confirms the know how update.
    /// </summary>
    public sealed record EditKnowHowResult(string Title, string Content);

    private sealed class KnowHowModel
    {
        [Required(ErrorMessage = "Title is required")]
        [MaxLength(200, ErrorMessage = "Title cannot exceed 200 characters")]
        public string? Title { get; set; }

        [Required(ErrorMessage = "Content is required")]
        [MaxLength(500000, ErrorMessage = "Content is too long")]
        public string? Content { get; set; }
    }
}
